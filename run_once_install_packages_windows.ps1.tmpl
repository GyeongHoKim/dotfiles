{{- if eq .chezmoi.os "windows" }}
# Windows Package Installation Script
# This script installs development tools using winget (Windows Package Manager)
# It runs once during initial setup

$ErrorActionPreference = "Stop"

Write-Host "Starting Windows package installation..." -ForegroundColor Green

# Function to check if winget is available
function Test-WingetAvailable {
    try {
        $null = winget --version
        return $true
    }
    catch {
        return $false
    }
}

# Function to install a package with winget
function Install-WingetPackage {
    param(
        [string]$PackageId,
        [string]$Name
    )

    Write-Host "Installing $Name..." -ForegroundColor Cyan
    try {
        winget install --id $PackageId --silent --accept-package-agreements --accept-source-agreements
        Write-Host "  ✓ $Name installed successfully" -ForegroundColor Green
    }
    catch {
        Write-Host "  ✗ Failed to install $Name" -ForegroundColor Red
        Write-Host "    Error: $_" -ForegroundColor Red
    }
}

# Check if winget is available
if (-not (Test-WingetAvailable)) {
    Write-Host "Error: winget is not available. Please ensure you're running Windows 11 or install App Installer from the Microsoft Store." -ForegroundColor Red
    exit 1
}

Write-Host "winget is available. Proceeding with installation..." -ForegroundColor Green

# Core development tools
$packages = @{
    # Version Control & CLI Tools
    "Git.Git" = "Git"
    "GitHub.cli" = "GitHub CLI"

    # Editors
    "vim.vim" = "Vim"
    "Neovim.Neovim" = "Neovim"
    "Microsoft.VisualStudioCode" = "Visual Studio Code"

    # Terminal & Shell Tools
    "Microsoft.WindowsTerminal" = "Windows Terminal"
    "wez.wezterm" = "WezTerm"
    "Microsoft.PowerShell" = "PowerShell 7+"
    "junegunn.fzf" = "fzf"

    # Window Manager
    "glzr-io.glazewm" = "GlazeWM"
    "glzr-io.zebar" = "Zebar"

    # Container Tools
    "Docker.DockerDesktop" = "Docker Desktop"

    # Infrastructure Tools
    "Kubernetes.kubectl" = "kubectl"
    "Hashicorp.Terraform" = "Terraform"
    "Pulumi.Pulumi" = "Pulumi"
    "Helm.Helm" = "Helm"

    # Build Tools
    "GoTask.Task" = "Task"
    "OpenJS.NodeJS.LTS" = "Node.js LTS"
    "GnuWin32.Make" = "GNU Make"

    # Utilities
    "BurntSushi.ripgrep.MSVC" = "ripgrep"
    "sharkdp.fd" = "fd"
    "tmux.tmux" = "tmux"
    "ajeetdsouza.zoxide" = "zoxide"
    "JesseDuffield.lazygit" = "lazygit"
    "GnuPG.Gpg4win" = "Gpg4win (GNU GPG for Windows)"

    # GUI Applications
    "Brave.Brave" = "Brave Browser"
    "Obsidian.Obsidian" = "Obsidian"
    "GIMP.GIMP" = "GIMP"
    "VideoLAN.VLC" = "VLC"
    "OBSProject.OBSStudio" = "OBS Studio"
    "Insomnia.Insomnia" = "Insomnia"
}

# Install packages
$totalPackages = $packages.Count
$currentPackage = 0

foreach ($package in $packages.GetEnumerator()) {
    $currentPackage++
    Write-Host "`n[$currentPackage/$totalPackages]" -ForegroundColor Yellow
    Install-WingetPackage -PackageId $package.Key -Name $package.Value
}

# Install mise (version manager for Node, Python, Go, Rust)
Write-Host "`n" -ForegroundColor Yellow
Install-WingetPackage -PackageId "jdx.mise" -Name "mise"

# Install Bun (JavaScript runtime and package manager)
Write-Host "`n--- Installing Bun ---" -ForegroundColor Cyan

try {
    # Check if 'bun' command exists
    $bunPath = (Get-Command bun -ErrorAction SilentlyContinue).Path
    if ($bunPath) {
        Write-Host "  ✓ Bun is already installed at $bunPath" -ForegroundColor Green
    } else {
        Write-Host "  Attempting to install Bun..." -ForegroundColor Cyan
        powershell -c "irm bun.sh/install.ps1|iex"
        $bunPath = (Get-Command bun -ErrorAction SilentlyContinue).Path
        if ($bunPath) {
            Write-Host "  ✓ Bun installed successfully" -ForegroundColor Green
        } else {
            Write-Host "  ✗ Bun installation failed: 'bun' command not found after installation." -ForegroundColor Red
        }
    }
}
catch {
    Write-Host "  ✗ Bun installation failed: $($_.Exception.Message)" -ForegroundColor Red
}

# Install Poetry if Python is available
Write-Host "`nChecking for Python and installing Poetry..." -ForegroundColor Cyan
$pythonAvailable = Get-Command py -ErrorAction SilentlyContinue

if ($pythonAvailable) {
    try {
        $poetryInstaller = (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content
        $poetryInstaller | py -
        Write-Host "  ✓ Poetry installed successfully" -ForegroundColor Green
    }
    catch {
        Write-Host "  ✗ Failed to install Poetry" -ForegroundColor Red
        Write-Host "    Error: $_" -ForegroundColor Red
    }
} else {
    Write-Host "  ! Python not found, skipping Poetry installation" -ForegroundColor Yellow
}

Write-Host "`n========================================" -ForegroundColor Green
Write-Host "Package installation complete!" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Green
Write-Host ""
Write-Host "Next steps:" -ForegroundColor Yellow
Write-Host "1. Restart your terminal to load new PATH entries" -ForegroundColor White
Write-Host "2. Launch Docker Desktop to start the Docker daemon" -ForegroundColor White
Write-Host "3. Run 'mise doctor' to verify mise installation" -ForegroundColor White
Write-Host "4. Run 'mise install' to install language runtimes (Node, Python, Go, Rust)" -ForegroundColor White

# Install Claude Code (Native)
Write-Host "`n" -ForegroundColor Yellow
Write-Host "--- Installing Claude Code (Native) ---" -ForegroundColor Cyan

if ($env:CI) {
    Write-Host "Skipping Claude Code installation in CI environment." -ForegroundColor Yellow
} else {
    try {
        # Check if 'claude' command exists
        $claudePath = (Get-Command claude -ErrorAction SilentlyContinue).Path
        if ($claudePath) {
            Write-Host "Claude Code is already installed at $claudePath" -ForegroundColor Green
        } else {
            Write-Host "Attempting to install Claude Code natively..." -ForegroundColor Cyan
            irm https://claude.ai/install.ps1 | iex
            $claudePath = (Get-Command claude -ErrorAction SilentlyContinue).Path
            if ($claudePath) {
                Write-Host "  ✓ Claude Code installed successfully to $claudePath" -ForegroundColor Green
            } else {
                Write-Host "  ✗ Claude Code installation failed: 'claude' command not found after installation." -ForegroundColor Red
            }
        }
    }
    catch {
        Write-Host "  ✗ Claude Code native installation failed: $($_.Exception.Message)" -ForegroundColor Red
    }
}

Write-Host ""
{{- end }}
